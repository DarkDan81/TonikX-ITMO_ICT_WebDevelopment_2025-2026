{% extends 'core/base.html' %}

{% block content %}
<div class="card p-4 shadow mb-4">
    <h2 class="text-primary">{{ conf.title }}</h2>
    <p><b>Тематики:</b> {{ conf.topics }}</p>
    <p><b>Где:</b> {{ conf.location }} ({{ conf.location_details }})</p>
    <p>{{ conf.description }}</p>
    <div class="alert alert-info"><b>Условия:</b> {{ conf.conditions }}</div>
    
    <!-- Кнопки управления участием -->
    <div class="mt-3">
        {% if user.is_authenticated %}
            {% if user_part %}
                <div class="alert alert-success d-flex justify-content-between align-items-center">
                    <span>Вы участвуете с темой: <b>{{ user_part.talk_title }}</b></span>
                    <div>
                        <a href="{% url 'edit_part' user_part.pk %}" class="btn btn-sm btn-warning">Изм.</a>
                        <a href="{% url 'del_part' user_part.pk %}" class="btn btn-sm btn-danger">Отмена</a>
                    </div>
                </div>
            {% else %}
                <a href="{% url 'participate' conf.pk %}" class="btn btn-success">Подать заявку на участие</a>
            {% endif %}
        {% else %}
            <p>Войдите, чтобы подать заявку.</p>
        {% endif %}
    </div>
</div>

<h3>Участники</h3>
<!-- Таблица участников -->
<table class="table table-striped table-hover">
    <thead class="table-dark">
        <tr>
            <th>Участник</th>
            <th>Тема доклада</th>
            <th>Статус публикации</th>
            <!-- Колонка только для админов (Разделение прав на клиенте) -->
            {% if user.is_staff %} <th>Действия (Admin)</th> {% endif %}
        </tr>
    </thead>
    <tbody>
        {% for p in participants %}
        <tr>
            <td>{{ p.user.username }}</td>
            <td>{{ p.talk_title }}</td>
            <td>
                {% if p.is_recommended %}
                    <span class="badge bg-success">Рекомендован</span>
                {% else %}
                    <span class="badge bg-secondary">На рассмотрении</span>
                {% endif %}
            </td>
            {% if user.is_staff %}
            <td>
                <a href="/admin/core/participation/{{ p.pk }}/change/" class="btn btn-sm btn-outline-dark">Управление</a>
            </td>
            {% endif %}
        </tr>
        {% endfor %}
    </tbody>
</table>

<hr>
<h3>Отзывы</h3>
{% for rev in reviews %}
    <div class="card mb-2">
        <div class="card-body py-2">
            <div class="d-flex justify-content-between">
                <strong>{{ rev.user.username }}</strong>
                <span class="badge bg-primary">{{ rev.rating }}/10</span>
            </div>
            <p class="mb-0">{{ rev.text }}</p>
            <small class="text-muted">{{ rev.created_at }}</small>
            
            <!-- Админ может удалять любые отзывы (пример прав) -->
            {% if user.is_staff %}
                <div class="text-end"><a href="/admin/core/review/{{ rev.pk }}/delete/" class="text-danger small">Удалить (Admin)</a></div>
            {% endif %}
        </div>
    </div>
{% endfor %}

{% if user.is_authenticated %}
    <h5 class="mt-4">Оставить отзыв</h5>
    <form method="post">
        {% csrf_token %}
        <div class="mb-2">
            {{ form.rating.label_tag }}
            {{ form.rating }}
        </div>
        <div class="mb-2">
            {{ form.text.label_tag }}
            {{ form.text }}
        </div>
        <button type="submit" name="review_submit" class="btn btn-primary">Отправить</button>
    </form>
{% endif %}
{% endblock %}